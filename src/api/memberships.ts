import { apiRequest } from './client';
import type { Membership, MembershipUsage } from '../types/crm';
import type { MembershipType } from '../types/crm';

export async function getMembershipTypes(): Promise<{ success: boolean; membershipTypes?: MembershipType[]; message?: string }> {
  const r = await apiRequest<{ membershipTypes: MembershipType[] }>('/membership-types');
  if (r.success && 'membershipTypes' in r) return { success: true, membershipTypes: (r as { membershipTypes: MembershipType[] }).membershipTypes };
  return { success: false, message: (r as { message?: string }).message };
}

export async function getMemberships(params?: { branchId?: string; customerId?: string; status?: string }) {
  const q = new URLSearchParams();
  if (params?.branchId) q.set('branchId', params.branchId);
  if (params?.customerId) q.set('customerId', params.customerId);
  if (params?.status) q.set('status', params.status);
  const query = q.toString();
  return apiRequest<{ memberships: Membership[] }>(`/memberships${query ? `?${query}` : ''}`);
}

export async function getMembership(id: string): Promise<{ success: boolean; membership?: Membership; usageHistory?: MembershipUsage[]; message?: string }> {
  const r = await apiRequest<{ membership: Membership; usageHistory: MembershipUsage[] }>(`/memberships/${id}`);
  if (r.success && 'membership' in r && 'usageHistory' in r) {
    const d = r as unknown as { membership: Membership; usageHistory: MembershipUsage[] };
    return { success: true, membership: d.membership, usageHistory: d.usageHistory };
  }
  return { success: false, message: (r as { message?: string }).message };
}

export async function createMembership(data: {
  customerId: string;
  membershipTypeId?: string;
  totalCredits: number;
  soldAtBranchId?: string;
  expiryDate?: string;
  customerPackage?: string;
  customerPackagePrice?: number;
  customerPackageExpiry?: string;
}) {
  return apiRequest<{ membership: Membership }>('/memberships', { method: 'POST', body: JSON.stringify(data) });
}

export async function recordMembershipUsage(membershipId: string, data: { creditsUsed?: number; notes?: string }) {
  return apiRequest<{ usage: MembershipUsage }>(`/memberships/${membershipId}/use`, { method: 'POST', body: JSON.stringify(data) });
}

export async function updateMembership(id: string, data: { usedCredits?: number; status?: string; expiryDate?: string }) {
  return apiRequest<{ membership: Membership }>(`/memberships/${id}`, { method: 'PATCH', body: JSON.stringify(data) });
}
